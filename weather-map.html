<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SA Weather</title>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.2.0/mapbox-gl.css' rel='stylesheet' />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l" crossorigin="anonymous">

    <style>
        .card {
            /*display: inline-block;*/
            /*border: solid gray 1px;*/
        }
        button {
            border: none;
            border-radius: 5px;
        }
    </style>
</head>
<body class="">

<h1 class="bg-primary text-white p-2">Weather App</h1>
<br>
<label class="ml-5 mr-2" for="input">Location</label>
<input id="input">
<button class="bg-primary text-white ml-3" id="btn">Find</button>
<br>
<br>
<div class="d-flex text-center" id="weather"></div>
<div class="d-flex text-center" id="weather2"></div>
<div class="m-auto w-100" id='map' style='width: 600px; height: 500px;'></div>

<script src="js/keys.js"></script>
<script src='https://api.mapbox.com/mapbox-gl-js/v2.2.0/mapbox-gl.js'></script>
<script src="js/map-geocoder-utils.js"></script>
<script src="https://code.jquery.com/jquery-2.2.4.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>
<script>

<!--    INITIAL COORDINATES-->
    var coordinates = [-98.4936, 29.4241];

    var coordinatesLon = coordinates[0];
    // console.log('lon ' + coordinatesLon)

    var coordinatesLat = coordinates[1];
    // console.log('lat ' + coordinatesLat)

// THE INITIAL MAP
mapboxgl.accessToken = MAPBOX_ACCESS_TOKEN;
    var map = new mapboxgl.Map({
        container: 'map', // ID
        style: 'mapbox://styles/mapbox/dark-v10',
        center: coordinates, // [lng, lat]
        zoom: 10
    });

    // CREATE MARKER
    var marker = new mapboxgl.Marker({
        color: 'red',
    })
        .setLngLat(coordinates)
        .setDraggable(true)
        .addTo(map);

//    GET OPEN WEATHER DATA AND FEED INTO SITE
function setWeather() {
    $.get("http://api.openweathermap.org/data/2.5/onecall", {
        APPID: OPEN_WEATHER_APPID,
        lon: coordinatesLon,
        lat: coordinatesLat,
        units: "imperial"
    }).done(function (data) {
        console.log(data);

        $("#weather").html("");

        for (var i = 0; i < data.daily.length - 3; i++) {

            var today = data.daily[i];
            var todayDate = new Date(today.dt * 1000).toDateString();

            // var icon = today.weather[0].icon
            // console.log(icon)
            // use search string method to replace data? in [icon]?

            var html = '<div class="card w-100 m-2">'
            html += '<div class="card-header">' + todayDate + '</div>'

            html += '<p>' + today.temp.min.toFixed(0) + '<span>&#8457;</span>\n / ' + today.temp.max.toFixed(0) + '<span>&#8457;</span>\n </p>'
            // html += '<hr>'
            // html += '<p>' + '<a href="http://openweathermap.org/img/w/[icon2].png"> </a>' + '</p>'
            html += '<hr>'
            html += '<p>' + 'Description: ' + '<strong>' + today.weather[0].description + '</strong>' + '</p>'
            html += '<hr>'
            html += '<p>' + 'Humidity: ' + '<strong>' + today.humidity + '</strong>' + '</p>'
            html += '<hr>'
            html += '<p>' + 'Wind: ' + '<strong>' + today.wind_speed.toFixed(0) + '</strong>' + ' mph' + '</p>'
            html += '<hr>'
            html += '<p>' + 'Pressure: ' + '<strong>' + today.pressure + '</strong>' + '</p>'

            html += '</div>'

            $('#weather').append(html);
        }
    });
}
setWeather();

// UPDATES FORECAST TO AREA OF MAP MARKER IS DRAGGED!
marker.on('dragend', function () {
    coordinatesLon = marker.getLngLat().lng;
    coordinatesLat = marker.getLngLat().lat;
    setWeather();
});

// FLY TO NEW LOCATION AND RESET MARKER VIA SEARCHBOX INFO
$('#btn').click(function () {
    var userInput = $('#input').val();
    geocode(userInput, MAPBOX_ACCESS_TOKEN).then(function (info){

        console.log(info);
        var newCenter = {
            lng: info[0],
            lat: info[1]
        };

        map.flyTo({center: newCenter});

        marker
            .setLngLat(newCenter)
            .setDraggable(true)
            .addTo(map)
            .setLngLat(newCenter);

        coordinatesLon = info[0]
        coordinatesLat = info[1]
        setWeather();
    });
});

</script>
</body>
</html>