<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SA Weather</title>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.2.0/mapbox-gl.css' rel='stylesheet' />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l" crossorigin="anonymous">
    <style>
        div {
            text-align: left;
            /*padding: 5px;*/
        }
        #alerts {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            /*max-width: 70vw;*/
            color: red;
        }
        #alerts:hover {
            white-space: normal;
        }
    </style>
</head>
<body class="">

<h1 class="bg-warning p-2 text-center">Weather</h1>
<h4 class="ml-2" id="subHead"></h4>
<h6 class="ml-2" id="alerts"></h6>
<br>
<!--<label class="ml-5 mr-2" for="input">Location</label>-->
<input class='ml-2' placeholder='search' id="input">
<button class="bg-primary text-white ml-3" id="btn">Find</button>
<br>
<br>
<div class="d-flex text-center mb-3" id="weather"></div>
<div class="m-auto w-100" id='map' style='width: 600px; height: 500px;'></div>

<script src="js/keys.js"></script>
<script src='https://api.mapbox.com/mapbox-gl-js/v2.2.0/mapbox-gl.js'></script>
<script src="js/map-geocoder-utils.js"></script>
<script src="https://code.jquery.com/jquery-2.2.4.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>
<script>

<!--    INITIAL COORDINATES-->
    var coordinates = [-98.4936, 29.4241];
    var coordinatesLon = coordinates[0];
    var coordinatesLat = coordinates[1];

// MAP
mapboxgl.accessToken = MAPBOX_ACCESS_TOKEN;
    var map = new mapboxgl.Map({
        container: 'map', // ID
        style: 'mapbox://styles/mapbox/dark-v10',
        center: coordinates, // [lng, lat]
        zoom: 10
    });

    // CREATE MARKER
    var marker = new mapboxgl.Marker({
        color: 'red',
    })
        .setLngLat(coordinates)
        .setDraggable(true)
        .addTo(map);

//    GET OPEN WEATHER DATA AND FEED INTO SITE
function setWeather() {
    $.get("http://api.openweathermap.org/data/2.5/onecall", {
        APPID: OPEN_WEATHER_APPID,
        lon: coordinatesLon,
        lat: coordinatesLat,
        units: "imperial"
    }).done(function (data) {
        console.log(data);
        $("#weather").html("");
        for (var i = 0; i < data.daily.length - 3; i++) {

            // work on these 2 lines
            var today = data.daily[i];
            var todayDate = new Date(today.dt * 1000).toDateString();
            var iconcode = today.weather[0].icon;
            var iconurl = "http://openweathermap.org/img/w/" + iconcode + ".png";

            // console.log(data.alerts)

            var html = '<div class="card w-100 m-1">'
            + '<div class="card-header">' + todayDate + '</div>'
            + '<div class="text-center" id="icon"><img alt="Weather" id="wicon" src=' + iconurl + '></div>'

            + '<div><p class="text-primary">' + today.temp.min.toFixed(0) + '</p> / <p class="text-danger"> ' + today.temp.max.toFixed(0) + '</p><span>&#8457;</span></div>'

                + '<div>Description: <strong>' + today.weather[0].description + '</strong>' + '</div>'
            // + '<div>Humidity: <strong>' + today.humidity + '</strong></div>'
            + '<div>Wind: ' + '<strong>' + today.wind_speed.toFixed(0) + ' mph</strong></div>'
            // + '<div>Pressure: <strong>' + today.pressure + '</strong></div>'
            + '</div></div>'
            $('#weather').append(html);
        }
function severeWeather() {
    for (var i = 0; i < data.alerts.length; i++) {
        $('#alerts').html("");
        var warning = data.alerts[i].description + '<br><br>'
        $('#alerts').append(warning);
    }
}
        severeWeather()
    });
}
setWeather();

// UPDATES FORECAST TO AREA OF MAP MARKER IS DRAGGED!
marker.on('dragend', function () {
    coordinatesLon = marker.getLngLat().lng;
    coordinatesLat = marker.getLngLat().lat;
    setWeather();
    reverseGeo();
});

// FLY TO NEW LOCATION AND RESET MARKER VIA SEARCHBOX INFO
$('#btn').click(function () {
    var userInput = $('#input').val();
    geocode(userInput, MAPBOX_ACCESS_TOKEN).then(function (info){
        console.log(info);
        var newCenter = {
            lng: info[0],
            lat: info[1]
        };
        map.flyTo({center: newCenter});
        marker
            .setLngLat(newCenter)
            .setDraggable(true)
            .addTo(map)
            .setLngLat(newCenter);
        coordinatesLon = info[0]
        coordinatesLat = info[1]
        setWeather();
        reverseGeo();
    });
});

// REVERSE GEOCODE TO FEED INTO SUBHEADER
function reverseGeo() {
    $.get("http://api.openweathermap.org/geo/1.0/reverse?lat=" + coordinatesLat + "&lon=" + coordinatesLon + "&limit=" + 5 + "&appid=" + OPEN_WEATHER_APPID)
    .done(function (data) {
        $("#subHead").html("");
        var html = data[0].name + ', ' + data[0].state; // 'name' = city
        $('#subHead').append(html);
    });
}
reverseGeo();

function radar() {
    $.get("https://tile.openweathermap.org/map/precipitation_new/15/-98.4936/29.4241.png?appid=" + OPEN_WEATHER_APPID)
        .done(function (data) {
console.log(data)

        });
}
radar();

// ZOOM CONTROLS TOP RIGHT
map.addControl(new mapboxgl.NavigationControl());

// WEATHER ALERTS


</script>
</body>
</html>