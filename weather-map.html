<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SA Weather</title>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.2.0/mapbox-gl.css' rel='stylesheet' />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.3/css/all.css">
    <style>
        div {
            text-align: left;
            margin: 2px 10px;
        }
        #wicon {
            height: 75px;
        }
        #map {
            width: 98vw;
            height: 500px;
            border-radius: 5px;
        }
        input {
            margin-left: 12px;
        }
        #btn {
            margin-left: 7px;
            border: none;
            border-radius: 5px;
            height: 35px;
            width: 50px;
        }
        section {
            align-items: center;
        }
        .mapboxgl-ctrl {
            margin: auto;
            padding: 0;
        }
        /*.hide {*/
        /*    display: none;*/
        /*}*/
    </style>
</head>

<!-- MAIN-->
<body>
    <section class="d-flex bg-primary text-white">
        <h1 class="p-2 text-center mr-auto">Weather App</h1>
        <h4 class="" id="subHead"></h4>
        <h4 class="mx-4 mt-1" id="temperature"></h4>
    </section>
    <br>
    <input class='p-1 pl-3' placeholder='search location' id="input">
    <button class="bg-primary text-white ml-2" id="btn">Find</button>
<!--    <button class="bg-primary text-white ml-2" id="celsiusbtn">CELSIUS</button>-->
    <br>
    <br>
    <h6 class="mx-5 text-danger" id="alerts"></h6>
    <div class="d-flex text-center m-1" id="weather"></div>
<div class="m-auto" id='map'></div>

<!--SCRIPTS-->
<script src="js/keys.js"></script>
<script src='https://api.mapbox.com/mapbox-gl-js/v2.2.0/mapbox-gl.js'></script>
<script src="js/map-geocoder-utils.js"></script>
<script src="https://code.jquery.com/jquery-2.2.4.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>
<script>

// INITIAL COORDINATES
    var coordinates = [-98.4936, 29.4241];
    var lon = coordinates[0];
    var lat = coordinates[1];

mapboxgl.accessToken = MAPBOX_ACCESS_TOKEN;
var mapStyle = {
    'version': 8,
    'name': 'Dark',
    'sources': {
        'mapbox': {
            'type': 'vector',
            'url': 'mapbox://mapbox.mapbox-streets-v8'
        },
        'overlay': {
            'type': 'image',
            'url': 'https://docs.mapbox.com/mapbox-gl-js/assets/radar.gif',
            'coordinates':
                [
                    [-80.425, 46.437],
                    [-71.516, 46.437],
                    [-71.516, 37.936],
                    [-80.425, 37.936]
                ]
        }
    },
    'sprite': 'mapbox://sprites/mapbox/dark-v10',
    'glyphs': 'mapbox://fonts/mapbox/{fontstack}/{range}.pbf',
    'layers': [
        {
            'id': 'background',
            'type': 'background',
            'paint': { 'background-color': '#111' }
        },
        {
            'id': 'water',
            'source': 'mapbox',
            'source-layer': 'water',
            'type': 'fill',
            'paint': { 'fill-color': '#2c2c2c' }
        },
        {
            'id': 'boundaries',
            'source': 'mapbox',
            'source-layer': 'admin',
            'type': 'line',
            'paint': {
                'line-color': '#797979',
                'line-dasharray': [2, 2, 6, 2]
            },
            'filter': ['all', ['==', 'maritime', 0]]
        },
        {
            'id': 'overlay',
            'source': 'overlay',
            'type': 'raster',
            'paint': { 'raster-opacity': 0.85 }
        },
        {
            'id': 'cities',
            'source': 'mapbox',
            'source-layer': 'place_label',
            'type': 'symbol',
            'layout': {
                'text-field': '{name_en}',
                'text-font': ['DIN Offc Pro Bold', 'Arial Unicode MS Bold'],
                'text-size': [
                    'interpolate',
                    ['linear'],
                    ['zoom'],
                    4,
                    9,
                    6,
                    12
                ]
            },
            'paint': {
                'text-color': '#969696',
                'text-halo-width': 2,
                'text-halo-color': 'rgba(0, 0, 0, 0.85)'
            }
        },
        {
            'id': 'states',
            'source': 'mapbox',
            'source-layer': 'place_label',
            'type': 'symbol',
            'layout': {
                'text-transform': 'uppercase',
                'text-field': '{name_en}',
                'text-font': ['DIN Offc Pro Bold', 'Arial Unicode MS Bold'],
                'text-letter-spacing': 0.15,
                'text-max-width': 7,
                'text-size': [
                    'interpolate',
                    ['linear'],
                    ['zoom'],
                    4,
                    10,
                    6,
                    14
                ]
            },
            'filter': ['==', ['get', 'class'], 'state'],
            'paint': {
                'text-color': '#969696',
                'text-halo-width': 2,
                'text-halo-color': 'rgba(0, 0, 0, 0.85)'
            }
        }
    ]
};

// var map = new mapboxgl.Map({
//     container: 'map',
//     // maxZoom: 5.99,
//     // minZoom: 4,
//     zoom: 5,
//     center: coordinates,
//     style: mapStyle
// });

// MAP
mapboxgl.accessToken = MAPBOX_ACCESS_TOKEN;
    var map = new mapboxgl.Map({
        container: 'map', // ID
        style: 'mapbox://styles/mapbox/dark-v10',
        // style: mapStyle,
        center: coordinates, // [lng, lat]
        zoom: 10
    });

// CREATE MARKER
    var marker = new mapboxgl.Marker({
        color: 'red',
    })
        .setLngLat(coordinates)
        .setDraggable(true)
        .addTo(map);

// GET OPEN WEATHER DATA AND FEED INTO SITE
function setWeather() {
    $.get("http://api.openweathermap.org/data/2.5/onecall", {
        APPID: OPEN_WEATHER_APPID,
        lon: lon,
        lat: lat,
        units: "imperial"
    }).done(function (data) {
        console.log(data);
        $("#weather").html("");
        for (var i = 0; i < data.daily.length - 3; i++) {
            var today = data.daily[i];
            var todayDate = new Date(today.dt * 1000).toDateString();
            var iconcode = today.weather[0].icon;
            var iconurl = "http://openweathermap.org/img/w/" + iconcode + ".png";

            // var myDate = new Date(1000*today.sunset);
            // var hours = date2.getHours();
            // var minutes = "0" + date.getMinutes();
            // var seconds = "0" + date.getSeconds();
            // var formattedTime = hours + ':' + minutes.substr(-2) + ':' + seconds.substr(-2);

            var html =
                '<div class="card w-100 m-2">'
                    + '<div class="card-header m-0 text-center">' + todayDate + '</div>'
                    + '<div id="farenheight" class="d-flex justify-content-center">'
                        + '<div class="text-primary m-1">' + today.temp.min.toFixed(0) + '</div>'
                        + '<div class="text-danger m-1">' + '/ ' + today.temp.max.toFixed(0) + '</div>'
                        + '<span class="p-1">&#8457;</span>'
                    + '</div>'
                    + '<div class="text-center" id="icon"> <img alt="Weather" id="wicon" src=' + iconurl + '> </div>'
                    + '<div>' + today.weather[0].description + '</div>'
                    + '<div><i class="fas fa-tint"></i> ' + (today.pop * 100).toFixed(0) + ' %</div>'
                    + '<div><i class="fas fa-wind"></i> ' + today.wind_speed.toFixed(0) + ' mph </div>'
                    // + '<div><i class="fas fa-moon"></i> ' + formattedTime + ' mph </div>'
                    + '<div>Humidity: <strong>' + today.humidity + '</strong></div>'
                + '</div>';

            console.log(data.current.uvi);

            $('#weather').append(html);
        }
// WEATHER ALERTS
    function severeWeather() {
        $('#alerts').html("");
        for (var i = 0; i < data.alerts.length; i++) {
            var warning =
                '<p class="text-uppercase m-0 font-weight-bold">' + data.alerts[i].event + ':</p>'
                + data.alerts[i].description + '<br><br>';
            $('#alerts').append(warning);
        }
    }
        function current() {
            $('#temperature').html("");
            var iconcode = data.current.weather[0].icon;
            var iconurl = "http://openweathermap.org/img/w/" + iconcode + ".png";
            var currentConditions =
                data.current.temp.toFixed(0) + '<span>&#8457;</span>'
                + '<img class="mr-3" alt="Weather" id="icon" src=' + iconurl + '>'
                // + '<p class="text-warning">UV / ' + data.current.uvi + '</p>';
            $('#temperature').append(currentConditions);
        }
        current();
        severeWeather();
    });
}
setWeather();

// UPDATES FORECAST TO AREA OF MAP MARKER IS DRAGGED!
marker.on('dragend', function () {
    lon = marker.getLngLat().lng;
    lat = marker.getLngLat().lat;
    setWeather();
    reverseGeo();
});

// FLY TO NEW LOCATION AND RESET MARKER VIA SEARCHBOX INFO
function fly() {
    var userInput = $('#input').val();
    geocode(userInput, MAPBOX_ACCESS_TOKEN).then(function (info) {
        console.log(info);
        var newCenter = {
            lng: info[0],
            lat: info[1]
        };
        map.flyTo({center: newCenter});
        marker
            .setLngLat(newCenter)
            .setDraggable(true)
            .addTo(map)
        lon = info[0]
        lat = info[1]
        setWeather();
        reverseGeo();
    });
}
// click button or press enter both trigger fly function
$('#btn').click(fly);
$("#input").keyup(function(event) {
    event.keyCode === 13? fly(): null;
});

// REVERSE GEOCODE TO FEED INTO SUBHEADER
function reverseGeo() {
    $.get("http://api.openweathermap.org/geo/1.0/reverse?lat=" + lat + "&lon=" + lon + "&limit=" + 5 + "&appid=" + OPEN_WEATHER_APPID)
    .done(function (data) {
        $("#subHead").html("");
        var html = data[0].name + ', ' + data[0].state
        $('#subHead').append(html);
    });
}
reverseGeo();

// ZOOM CONTROLS TOP RIGHT
map.addControl(new mapboxgl.NavigationControl());

</script>
</body>
</html>